# cicd-vicky.yml

# ë¹„í‚¤ëŠ” ì¶”í›„ HF_AUTH_TOKEN_ANNA ë¥¼ ë¹„í‚¤ê»„ë¡œ ë°”ê¿”ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤. ì¬í‚¤ì—ê²Œ ë¬¸ì˜


# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build and Push to Artifact Registry

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë¸Œëœì¹˜ ì´ë¦„ì„ ë³€ê²½í•˜ì„¸ìš”.
on:
  push:
    branches:
      - feat/24-comment-Dockerfile

jobs:
  build-and-push:
    name: Build and Push Docker image to Artifact Registry
    runs-on: self-hosted
    # id-token ê¶Œí•œì€ WIFë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°í•´ë„ ë©ë‹ˆë‹¤. (ì„ íƒ ì‚¬í•­)
    # permissions:
    #   contents: 'read'

    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    env:
      GCP_PROJECT_ID: ktb8team-458916 
      ARTIFACT_REGISTRY_LOCATION: "asia-east1"
      ARTIFACT_REGISTRY_REPO: "ktb8team"
      IMAGE_NAME: "dev/ai-vicky"
      DOCKERFILE_PATH: "Dockerfile.cpu"

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # NVIDIA Container Toolkit ìƒíƒœ í™•ì¸
      - name: Verify NVIDIA Container Toolkit
        run: |
          nvidia-smi
          docker info | grep -i nvidia

      # 2. Google Cloud ì¸ì¦ (ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì‚¬ìš©)
      # ì¤‘ìš”: GitHub ì €ì¥ì†Œ Secretsì— 'GCP_SA_KEY' ì´ë¦„ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON íŒŒì¼ì˜ ë‚´ìš©ì„ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Google Cloud SDK (gcloud CLI) ì„¤ì • (ì„ íƒ ì‚¬í•­, auth ë‹¨ê³„ì—ì„œ ì´ë¯¸ gcloudê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
      # - name: Set up Cloud SDK
      #   uses: 'google-github-actions/setup-gcloud@v2'

      # 4. Artifact Registryì— Docker ì¸ì¦ ì„¤ì •
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev --quiet

      # 5. Docker BuildKit í™œì„±í™” + GPU ì‚¬ìš© + ìºì‹œ ìµœì í™”
      - name: Build Docker image with GPU
        run: |
          DOCKER_BUILDKIT=1 docker build \
            --platform=linux/amd64 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg CUDA_VISIBLE_DEVICES=all \
            --build-arg HF_AUTH_TOKEN=${{ secrets.HF_AUTH_TOKEN_ANNA }} \
            -t ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -f ${{ env.DOCKERFILE_PATH }} .

      # 6. Docker ì´ë¯¸ì§€ë¥¼ Artifact Registryì— í‘¸ì‹œ
      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # (ì„ íƒ ì‚¬í•­) ìƒì„±ëœ ì´ë¯¸ì§€ ì „ì²´ ì£¼ì†Œ ì¶œë ¥
      - name: Output image URL
        run: |
          echo "Image pushed to: ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      # 7. Docker ë ˆì´ì–´ ìºì‹±
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Discordë¡œ ë¹Œë“œ ì„±ê³µ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Discord notification
        if: success()
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
          
          # ì´ë¯¸ì§€ URL
          IMAGE_URL="${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # ì»¤ë°‹ ì‘ì„±ìì™€ ë©”ì‹œì§€
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          
          # Discord ì›¹í›… í˜ì´ë¡œë“œ
          curl -H "Content-Type: application/json" -X POST -d '{
            "username": "ğŸ¤– AI ë¹Œë“œ ë´‡",
            "avatar_url": "https://avatars.githubusercontent.com/u/583231",
            "embeds": [{
              "title": "âœ… ğŸš€ AI ì„œë¹„ìŠ¤ ë¹Œë“œ ì„±ê³µ! ğŸ‰ ğŸŠ",
              "color": 3066993,
              "description": "ğŸ”¥ Vickyì˜ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒŸ ì§ì§ì§~ ğŸ™Œ",
              "fields": [
                {
                  "name": "ğŸ•’ ë¹Œë“œ ì‹œê°„ â°",
                  "value": "ğŸ—“ï¸ '"${CURRENT_TIME}"' ğŸ•°ï¸",
                  "inline": true
                },
                {
                  "name": "ğŸ‘¨â€ğŸ’» ì»¤ë°‹ ì‘ì„±ì âœï¸",
                  "value": "ğŸ§™ '"${COMMIT_AUTHOR}"' ğŸ’ª",
                  "inline": true
                },
                {
                  "name": "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€ ğŸ’¬",
                  "value": "ğŸ“Œ '"${COMMIT_MESSAGE}"' ğŸ“"
                },
                {
                  "name": "ğŸ–¼ï¸ ì´ë¯¸ì§€ URL ğŸ“¦",
                  "value": "```'"${IMAGE_URL}"'```"
                },
                {
                  "name": "ğŸ”— GitHub Actions ğŸ”„",
                  "value": "ğŸ“Š [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ğŸ“ˆ"
                }
              ],
              "footer": {
                "text": "ğŸ† ktb8team AI ì´ë¯¸ì§€ ë¹Œë“œ ì‹œìŠ¤í…œ ğŸ› ï¸"
              },
              "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL_AI }}
