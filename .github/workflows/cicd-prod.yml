# cicd-anna.yml

# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build and Push Anna AI Image

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë¸Œëœì¹˜ ì´ë¦„ì„ ë³€ê²½í•˜ì„¸ìš”.
on:
  push:
    branches:
      # ë¸Œëœì¹˜ëŠ” ë§ê²Œ ì˜ ë°”ê¿”ì„œ.
      # feat ë¸Œëœì¹˜ëŠ” í…ŒìŠ¤íŠ¸ìš©
      - main


jobs:
  build-and-push:
    # ì»¤ë°‹ ë©”ì‹œì§€ì— [gpu]ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ contains(github.event.head_commit.message, '[gpu]') }}
    name: Build and Push Docker image
    runs-on: self-hosted
    

    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    env:
      GCP_PROJECT_ID: ktb8team-458916 
      ARTIFACT_REGISTRY_LOCATION: "asia-east1"
      ARTIFACT_REGISTRY_REPO: "ktb8team"
      IMAGE_NAME: "prod/ai"
      DOCKERFILE_PATH: "Dockerfile.gpu"

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ
      - name: Get commit message
        id: commit_message
        run: |
          {
            echo 'message<<EOF'
            git log -1 --pretty=%B
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
        
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env) - GPUìš© í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_GPU_PROD }}" > .env

      # í™˜ê²½ë³€ìˆ˜ë“¤ì„ GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì¶”ì¶œ
      - name: Load environment variables
        run: |
          # .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ë“¤ì„ ì½ì–´ì„œ GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
          set -a
          source .env
          set +a
          echo "BUILD_HF_AUTH_TOKEN=$HF_AUTH_TOKEN" >> $GITHUB_ENV
          echo "BUILD_LANGSMITH_TRACING=$LANGSMITH_TRACING" >> $GITHUB_ENV
          echo "BUILD_LANGSMITH_ENDPOINT=$LANGSMITH_ENDPOINT" >> $GITHUB_ENV
          echo "BUILD_LANGSMITH_API_KEY=$LANGSMITH_API_KEY" >> $GITHUB_ENV
          echo "BUILD_LANGCHAIN_PROJECT=$LANGCHAIN_PROJECT" >> $GITHUB_ENV
          echo "BUILD_GEMINI_API_KEY=$GEMINI_API_KEY" >> $GITHUB_ENV
          echo "BUILD_USE_REMOTE_CHROMA=$USE_REMOTE_CHROMA" >> $GITHUB_ENV
          echo "BUILD_QDRANT_API_KEY=$QDRANT_API_KEY" >> $GITHUB_ENV
          echo "BUILD_QDRANT_URL=$QDRANT_URL" >> $GITHUB_ENV
          echo "BUILD_QDRANT_COLLECTION=$QDRANT_COLLECTION" >> $GITHUB_ENV
          echo "BUILD_GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      # NVIDIA Container Toolkit ìƒíƒœ í™•ì¸
      - name: Verify NVIDIA Container Toolkit
        run: |
          nvidia-smi || true
          docker info | grep -i nvidia || true

      # 2. Google Cloud ì¸ì¦ (ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì‚¬ìš©)
      # ì¤‘ìš”: GitHub ì €ì¥ì†Œ Secretsì— 'GCP_SA_KEY' ì´ë¦„ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON íŒŒì¼ì˜ ë‚´ìš©ì„ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Google Cloud SDK (gcloud CLI) ì„¤ì • (ì„ íƒ ì‚¬í•­, auth ë‹¨ê³„ì—ì„œ ì´ë¯¸ gcloudê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # 4. Artifact Registryì— Docker ì¸ì¦ ì„¤ì •
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev --quiet

      # 5. Docker ë ˆì´ì–´ ìºì‹±
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 6. Docker BuildKit í™œì„±í™” + GPU ì‚¬ìš© - í™˜ê²½ë³€ìˆ˜ë¥¼ ê°œë³„ ë¹Œë“œ ì¸ìë¡œ ì „ë‹¬
      - name: Build Docker image with GPU
        run: |
          DOCKER_BUILDKIT=1 docker build \
            --platform=linux/amd64 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg CUDA_VISIBLE_DEVICES=all \
            --build-arg HF_AUTH_TOKEN="${{ env.BUILD_HF_AUTH_TOKEN }}" \
            --build-arg LANGSMITH_TRACING="${{ env.BUILD_LANGSMITH_TRACING }}" \
            --build-arg LANGSMITH_ENDPOINT="${{ env.BUILD_LANGSMITH_ENDPOINT }}" \
            --build-arg LANGSMITH_API_KEY="${{ env.BUILD_LANGSMITH_API_KEY }}" \
            --build-arg LANGCHAIN_PROJECT="${{ env.BUILD_LANGCHAIN_PROJECT }}" \
            --build-arg GEMINI_API_KEY="${{ env.BUILD_GEMINI_API_KEY }}" \
            --build-arg USE_REMOTE_CHROMA="${{ env.BUILD_USE_REMOTE_CHROMA }}" \
            --build-arg QDRANT_API_KEY="${{ env.BUILD_QDRANT_API_KEY }}" \
            --build-arg QDRANT_URL="${{ env.BUILD_QDRANT_URL }}" \
            --build-arg QDRANT_COLLECTION="${{ env.BUILD_QDRANT_COLLECTION }}" \
            --build-arg GITHUB_TOKEN="${{ env.BUILD_GITHUB_TOKEN }}" \
            --label git_commit="${{ github.sha }}" \
            --label git_author="${{ github.actor }}" \
            --label git_message="${{ steps.commit_message.outputs.message }}" \
            -t ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest \
            -f ${{ env.DOCKERFILE_PATH }} .

      # ë¹Œë“œ í›„ ì´ë¯¸ì§€ íƒœê·¸ í™•ì¸
      - name: List Docker images
        run: docker images

      # í•„ìš”ì‹œ ê°•ì œë¡œ latest íƒœê·¸ ë¶™ì´ê¸°
      - name: Retag image as latest
        run: |
          docker tag ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest

      # ì‹¤íŒ¨ ì‹œ ê°„ë‹¨í•œ ì•Œë¦¼ ì¶”ê°€ 
      - name: Send failure notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "content": "ğŸš¨ PROD ë¹Œë“œ ì‹¤íŒ¨! ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì„ í™•ì¸í•´ì£¼ì„¸ìš”: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.DISCORD_WEBHOOK_URL_ALL }}

      # 7. Docker ì´ë¯¸ì§€ë¥¼ Artifact Registryì— í‘¸ì‹œ
      - name: Push Docker image to Artifact Registry
        run: |
          echo "Pushing :sha tag (${{ github.sha }})..."
          docker push ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          echo "---------------------------------------------------------------------"
          echo "Inspecting local 'latest' tag before pushing to registry:"
          # ë¡œì»¬ì— íƒœê·¸ëœ latest ì´ë¯¸ì§€ì˜ ìƒì„¸ ì •ë³´ (íŠ¹íˆ Image ID ë˜ëŠ” Digest) í™•ì¸
          docker inspect ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest
          echo "---------------------------------------------------------------------"
          
          echo "Attempting to push :latest tag..."
          # latest íƒœê·¸ í‘¸ì‹œ ì‹œë„. ActionsëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëª…ë ¹ì–´ì˜ ëª¨ë“  ì¶œë ¥ì„ ë¡œê¹…í•©ë‹ˆë‹¤.
          docker push ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest
          
          echo "---------------------------------------------------------------------"
          echo "Describing 'latest' tag in Artifact Registry AFTER push (via gcloud):"
          # gcloudë¥¼ ì‚¬ìš©í•˜ì—¬ Artifact Registryì—ì„œ ì§ì ‘ latest íƒœê·¸ì˜ ì •ë³´(digest, ì—…ë°ì´íŠ¸ ì‹œê°„ ë“±)ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          # ì´ë¥¼ í†µí•´ Docker í´ë¼ì´ì–¸íŠ¸ì˜ ë³´ê³ ë‚˜ UI ì§€ì—°ê³¼ ê´€ê³„ì—†ì´ ì‹¤ì œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          gcloud artifacts docker images describe ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest --format='default(image_summary.digest, version, tags, update_time)' || echo "Error: Failed to describe 'latest' tag from Artifact Registry, or it does not exist."
          echo "---------------------------------------------------------------------"
          echo "Verifying pushed :sha tag in Artifact Registry (via gcloud):"
          # ë¹„êµë¥¼ ìœ„í•´ ë°©ê¸ˆ í‘¸ì‹œí•œ :sha íƒœê·¸ì˜ ì •ë³´ë„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          gcloud artifacts docker images describe ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --format='default(image_summary.digest, version, tags, update_time)' || echo "Error: Failed to describe ':sha' tag from Artifact Registry."
          echo "---------------------------------------------------------------------"

      # 8. ì´ë¯¸ì§€ ì£¼ì†Œ ì¶œë ¥
      - name: Output image URL
        run: |
          echo "Image pushed to: ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

