# cicd-badge-dev.yml

# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build and Push Badge Service to Artifact Registry - Development

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
# í•´ë‹¹ ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë¸Œëœì¹˜ ì´ë¦„ì„ ë³€ê²½í•˜ì„¸ìš”.  
on:
  push:
    branches:
      - main
      - feat/125-badge-regularInstance

jobs:
  build-push:
    # ì»¤ë°‹ ë©”ì‹œì§€ì— [badge]ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ contains(github.event.head_commit.message, '[badge]') }}
    name: Build and Push to Artifact Registry
    runs-on: self-hosted
    # id-token ê¶Œí•œì€ WIFë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°í•´ë„ ë©ë‹ˆë‹¤. (ì„ íƒ ì‚¬í•­)
    # permissions:
    #   contents: 'read'

    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •  
    env:
      GCP_PROJECT_ID: ktb8team-458916 
      ARTIFACT_REGISTRY_LOCATION: "asia-east1"
      ARTIFACT_REGISTRY_REPO: "ktb8team"
      IMAGE_NAME: "prod/badge"
      DOCKERFILE_PATH: "Dockerfile.badge"

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # NVIDIA Container Toolkit ìƒíƒœ í™•ì¸
      - name: Verify NVIDIA Container Toolkit
        run: |
          nvidia-smi || true
          docker info | grep -i nvidia || true

      # 2. Google Cloud ì¸ì¦ (ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì‚¬ìš©)
      # ì¤‘ìš”: GitHub ì €ì¥ì†Œ Secretsì— 'GCP_SA_KEY' ì´ë¦„ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON íŒŒì¼ì˜ ë‚´ìš©ì„ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Google Cloud SDK (gcloud CLI) ì„¤ì • (ì„ íƒ ì‚¬í•­, auth ë‹¨ê³„ì—ì„œ ì´ë¯¸ gcloudê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # 4. Artifact Registryì— Docker ì¸ì¦ ì„¤ì •
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev --quiet

      # ğŸ”§ HF í† í° ì¶”ì¶œ ë° Docker ë¹Œë“œ (ë°°ì§€ ì„œë¹„ìŠ¤ìš©)
      - name: Extract HF Token and Build Docker image
        run: |
          echo "ğŸ”§ HF í† í° ì¶”ì¶œ ì¤‘..."
          
          # GitHub Secretì—ì„œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë“¤ ì¶”ì¶œ
          echo '${{ secrets.ENV_BADGE_PROD }}' > temp_env
          export HF_AUTH_TOKEN_VICKY=$(grep "HF_AUTH_TOKEN_VICKY=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export BE_SERVER_URL=$(grep "BE_SERVER_URL=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export AI_SERVER_URL=$(grep "AI_SERVER_URL=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export GCP_PROJECT_ID=$(grep "GCP_PROJECT_ID=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export ARTIFACT_REGISTRY_LOCATION=$(grep "ARTIFACT_REGISTRY_LOCATION=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export GCP_QUEUE_NAME=$(grep "GCP_QUEUE_NAME=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          export GCP_SERVICE_EMAIL=$(grep "GCP_SERVICE_EMAIL=" temp_env | cut -d'=' -f2- | tr -d '"' | tr -d ' ')
          
          echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ë“¤ í™•ì¸:"
          echo "HF_AUTH_TOKEN_VICKY: ${HF_AUTH_TOKEN_VICKY:0:10}****"
          echo "BE_SERVER_URL: $BE_SERVER_URL"
          echo "AI_SERVER_URL: $AI_SERVER_URL"
          echo "GCP_PROJECT_ID: $GCP_PROJECT_ID"
          echo "ARTIFACT_REGISTRY_LOCATION: $ARTIFACT_REGISTRY_LOCATION"
          echo "GCP_QUEUE_NAME: $GCP_QUEUE_NAME"
          echo "GCP_SERVICE_EMAIL: $GCP_SERVICE_EMAIL"
          
          # HF í† í° ìœ íš¨ì„± ê²€ì¦
          if [ -z "$HF_AUTH_TOKEN_VICKY" ]; then
            echo "âŒ HF_AUTH_TOKEN_VICKY ì¶”ì¶œ ì‹¤íŒ¨!"
            exit 1
          fi
          
          echo "âœ… HF í† í° ì¶”ì¶œ ì„±ê³µ!"
          
          # ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë°°ì§€ ëª¨ë¸ í¬í•¨)
          echo "ğŸ³ ë°°ì§€ ì„œë¹„ìŠ¤ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          echo "ğŸ“¦ ë¹Œë“œ ì¤‘ ë‹¤ìŒ ëª¨ë¸ë“¤ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤:"
          echo "  - ControlNet Canny (lllyasviel/control_v11p_sd15_canny)"
          echo "  - SD 1.5 Base (runwayml/stable-diffusion-v1-5)"
          echo "  - Badge LoRA Models (HHBeen/badge_LoRA)"
          echo "ğŸ”‘ Docker ë¹Œë“œì— ì „ë‹¬í•  HF í† í°: ${HF_AUTH_TOKEN_VICKY:0:10}****"
          
          DOCKER_BUILDKIT=1 docker build \
            --platform=linux/amd64 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg CUDA_VISIBLE_DEVICES=all \
            --build-arg HUGGINGFACE_HUB_TOKEN="${HF_AUTH_TOKEN_VICKY}" \
            --build-arg BE_SERVER_URL="${BE_SERVER_URL}" \
            --build-arg AI_SERVER_URL="${AI_SERVER_URL}" \
            --build-arg GCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            --build-arg ARTIFACT_REGISTRY_LOCATION="${ARTIFACT_REGISTRY_LOCATION}" \
            --build-arg GCP_QUEUE_NAME="${GCP_QUEUE_NAME}" \
            --build-arg GCP_SERVICE_EMAIL="${GCP_SERVICE_EMAIL}" \
            -t ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest \
            -f ${{ env.DOCKERFILE_PATH }} .
          
          echo "âœ… ë°°ì§€ ì„œë¹„ìŠ¤ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm temp_env

      # 5. Docker ì´ë¯¸ì§€ë¥¼ Artifact Registryì— í‘¸ì‹œ
      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest

      # 6. Docker ë ˆì´ì–´ ìºì‹±
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # ì´ë¯¸ì§€ ì£¼ì†Œ ì¶œë ¥
      - name: Output image URL
        run: |
          echo "Image pushed to: ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
      # ğŸ” ì•ˆì „í•œ Docker ì‹¤í–‰ ê°€ì´ë“œ ì¶œë ¥
      - name: Output secure Docker run command
        run: |
          echo ""
          echo "ğŸ” ë³´ì•ˆ Docker ì‹¤í–‰ ê°€ì´ë“œ:"
          echo "================================="
          echo ""
          echo "ğŸ“ í™˜ê²½ ë³€ìˆ˜ì™€ í•¨ê»˜ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰:"
          echo ""
          echo "docker run \\"
          echo "  -e HF_AUTH_TOKEN_VICKY=\"your_hf_token_here\" \\"
          echo "  -e BE_SERVER_URL=\"https://tebutebu.com/\" \\"
          echo "  -e AI_SERVER_URL=\"https://badge-prod-325953343194.asia-east1.run.app/\" \\"
          echo "  -e GCP_PROJECT_ID=\"ktb8team-458916\" \\"
          echo "  -e ARTIFACT_REGISTRY_LOCATION=\"asia-east1\" \\"
          echo "  -e GCP_QUEUE_NAME=\"badge-queue\" \\"
          echo "  -e GCP_SERVICE_EMAIL=\"ai-task-invoker@ktb8team-458916.iam.gserviceaccount.com\" \\"
          echo "  -p 8080:8080 \\"
          echo "  --gpus all \\"
          echo "  ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "ğŸ”’ ë³´ì•ˆ ì°¸ê³ ì‚¬í•­:"
          echo "- HF í† í°ì€ ì´ë¯¸ì§€ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          echo "- ëŸ°íƒ€ì„ì—ë§Œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤"
          echo "- ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì‹œ .env íŒŒì¼ë„ í•¨ê»˜ ì œê±°ë©ë‹ˆë‹¤"
          echo ""
          
      # Discordë¡œ ë¹Œë“œ ì„±ê³µ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Discord notification
        if: success()
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
          
          # ì´ë¯¸ì§€ URL
          IMAGE_URL="${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # ì»¤ë°‹ ì‘ì„±ìì™€ ë©”ì‹œì§€
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          
          # Discord ì›¹í›… í˜ì´ë¡œë“œ
          curl -H "Content-Type: application/json" -X POST -d '{
            "username": "ğŸ¤– PUMATI ì¸ê³µì§€ëŠ¥ ë¹Œë“œ ë´‡",
            "avatar_url": "https://avatars.githubusercontent.com/u/583231",
            "content": "ğŸŒŸ **'"${COMMIT_AUTHOR}"'** ë‹˜ì´ ë°°ì§€ ì„œë¹„ìŠ¤ ë¹Œë“œë¥¼ ì™„ë£Œí•˜ê³  Artifact Registryì— í‘¸ì‹œí–ˆìŠµë‹ˆë‹¤! ğŸ…ğŸ“¦\n\nğŸ“¦ **ë°°ì§€ ëª¨ë¸ í¬í•¨ ë¹Œë“œ**: ControlNet, SD 1.5, LoRA ëª¨ë¸ì´ Docker ì´ë¯¸ì§€ì— ë¯¸ë¦¬ í¬í•¨ë˜ì–´ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!\n\nğŸ” **ë³´ì•ˆ ê°•í™”**: HF í† í°ì´ ì´ë¯¸ì§€ì— í¬í•¨ë˜ì§€ ì•Šê³  ëŸ°íƒ€ì„ì—ë§Œ ì „ë‹¬ë©ë‹ˆë‹¤!",
            "embeds": [{
                              "title": "âœ… ë°°ì§€ ì„œë¹„ìŠ¤ ë¹Œë“œ & í‘¸ì‹œ ì„±ê³µ! ğŸ…ğŸ‰ (ë³´ì•ˆ ê°•í™”)",
                "color": 3066993,
                "description": "ğŸ”¥ **'"${COMMIT_AUTHOR}"'** ë‹˜ì´ í‘¸ì‹œí•œ ë°°ì§€ ì„œë¹„ìŠ¤ ì½”ë“œì˜ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Artifact Registry í‘¸ì‹œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ™Œ\n\nğŸš€ **ë°°ì§€ ìƒì„±ì— í•„ìš”í•œ ëª¨ë“  AI ëª¨ë¸ì´ ì´ë¯¸ì§€ì— í¬í•¨ë˜ì–´ ìˆì–´ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤!**\n\nğŸ” **ë³´ì•ˆ**: HF í† í°ì€ ëŸ°íƒ€ì„ì—ë§Œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ë˜ì–´ ì•ˆì „í•©ë‹ˆë‹¤!",
              "fields": [
                {
                  "name": "ğŸ‘¨â€ğŸ’» í‘¸ì‹œí•œ ì‚¬ëŒ ğŸ‘‘",
                  "value": "```fix\n'"${COMMIT_AUTHOR}"'\n```",
                  "inline": false
                },
                {
                  "name": "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€ ğŸ’¬",
                  "value": "ğŸ“Œ '"${COMMIT_MESSAGE}"' ğŸ“",
                  "inline": false
                },
                {
                  "name": "ğŸ•’ ë¹Œë“œ ì‹œê°„ â°",
                  "value": "ğŸ—“ï¸ '"${CURRENT_TIME}"' ğŸ•°ï¸",
                  "inline": true
                },
                {
                  "name": "ğŸ–¼ï¸ ì´ë¯¸ì§€ URL ğŸ“¦",
                  "value": "```'"${IMAGE_URL}"'```",
                  "inline": false
                },
                {
                  "name": "ğŸ” ë³´ì•ˆ ì‹¤í–‰ ê°€ì´ë“œ ğŸ›¡ï¸",
                  "value": "```bash\ndocker run -e HF_AUTH_TOKEN_VICKY=\"your_token\" -p 8080:8080 --gpus all \\\n  '"${IMAGE_URL}"'\n```",
                  "inline": false
                },
                {
                  "name": "ğŸ”„ GitHub Actions ğŸ”",
                  "value": "[ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                  "inline": false
                }
              ],
              "thumbnail": {
                "url": "https://robohash.org/'"${COMMIT_AUTHOR}"'?set=set3&size=128x128"
              },
                                "footer": {
                    "text": "ğŸ† ktb8team ë³´ì•ˆ ê°•í™” ë°°ì§€ ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹œìŠ¤í…œ - '"${COMMIT_AUTHOR}"' ë‹˜ì˜ ì‘ì—… ğŸ› ï¸"
                  }
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL_AI }}
