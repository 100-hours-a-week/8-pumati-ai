# ==========================================
# Stage 1: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ë° ë¹Œë“œ ìŠ¤í…Œì´ì§€
# ==========================================
FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime AS model-downloader

# ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜ (ì´ ìŠ¤í…Œì´ì§€ì—ì„œë§Œ ì‚¬ìš©)
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ìºì‹œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV HUGGINGFACE_HUB_CACHE=/app/.cache/huggingface
ENV TRANSFORMERS_CACHE=/app/.cache/transformers
ENV HF_HOME=/app/.cache/huggingface
RUN mkdir -p /app/.cache/huggingface /app/.cache/transformers

# Python ì˜ì¡´ì„± ì„¤ì¹˜ (ëª¨ë¸ ë‹¤ìš´ë¡œë“œìš©)
RUN pip install --upgrade pip && \
    pip install huggingface_hub transformers diffusers torch

# ğŸš€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
ARG HUGGINGFACE_HUB_TOKEN
ENV HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN}

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/usr/bin/env python3\n\
import os\n\
import sys\n\
import time\n\
from huggingface_hub import login, snapshot_download\n\
import torch\n\
\n\
print("ğŸš€ Docker ë¹Œë“œ ì¤‘ ë°°ì§€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘")\n\
\n\
# HF í† í° í™•ì¸\n\
token = os.getenv("HUGGINGFACE_HUB_TOKEN")\n\
if not token:\n\
    print("âŒ HUGGINGFACE_HUB_TOKENê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")\n\
    sys.exit(1)\n\
\n\
print(f"ğŸ”‘ í† í° í™•ì¸: {token[:10]}****")\n\
\n\
# Hugging Face ë¡œê·¸ì¸\n\
try:\n\
    login(token=token)\n\
    print("âœ… Hugging Face ë¡œê·¸ì¸ ì„±ê³µ!")\n\
except Exception as e:\n\
    print(f"âŒ Hugging Face ë¡œê·¸ì¸ ì‹¤íŒ¨: {e}")\n\
    sys.exit(1)\n\
\n\
# ìºì‹œ ë””ë ‰í† ë¦¬ í™•ì¸\n\
cache_dir = "/app/.cache/huggingface"\n\
print(f"ğŸ“ ìºì‹œ ë””ë ‰í† ë¦¬: {cache_dir}")\n\
\n\
def download_with_retry(repo_id, max_retries=3):\n\
    """ì¬ì‹œë„ ë¡œì§ì´ ìˆëŠ” ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜"""\n\
    for attempt in range(max_retries):\n\
        try:\n\
            print(f"ğŸ“¥ {repo_id} ë‹¤ìš´ë¡œë“œ ì‹œë„ {attempt + 1}/{max_retries}...")\n\
            snapshot_download(\n\
                repo_id,\n\
                cache_dir=cache_dir,\n\
                local_files_only=False,\n\
                resume_download=True,\n\
                max_workers=2\n\
            )\n\
            print(f"âœ… {repo_id} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")\n\
            return True\n\
        except Exception as e:\n\
            print(f"âŒ {repo_id} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}): {e}")\n\
            if attempt < max_retries - 1:\n\
                wait_time = (attempt + 1) * 10\n\
                print(f"â³ {wait_time}ì´ˆ í›„ ì¬ì‹œë„...")\n\
                time.sleep(wait_time)\n\
            else:\n\
                print(f"ğŸ’¥ {repo_id} ìµœì¢… ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!")\n\
                return False\n\
    return False\n\
\n\
try:\n\
    # ğŸš€ ë°°ì§€ ì„œë¹„ìŠ¤ì— í•„ìš”í•œ ëª¨ë¸ë“¤ ë‹¤ìš´ë¡œë“œ\n\
    models = [\n\
        ("lllyasviel/control_v11p_sd15_canny", "ControlNet Canny"),\n\
        ("runwayml/stable-diffusion-v1-5", "SD 1.5 Base"),\n\
        ("HHBeen/badge_LoRA", "Badge LoRA Models")\n\
    ]\n\
    \n\
    for i, (repo_id, name) in enumerate(models, 1):\n\
        print(f"ğŸ“¥ {i}/{len(models)} {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...")\n\
        if not download_with_retry(repo_id):\n\
            print(f"ğŸ’¥ {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ë¡œ ë¹Œë“œ ì¤‘ë‹¨!")\n\
            sys.exit(1)\n\
        print(f"ğŸ‰ {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!")\n\
        print("ğŸ’¾ ë©”ëª¨ë¦¬ ì •ë¦¬ ì¤‘...")\n\
        time.sleep(2)  # ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œê°„\n\
    \n\
    print("ğŸ‰ ëª¨ë“  ë°°ì§€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!")\n\
    print("ğŸ’¡ ëŸ°íƒ€ì„ì—ì„œ ìºì‹œëœ ëª¨ë¸ì„ ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.")\n\
    \n\
except Exception as e:\n\
    print(f"âŒ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")\n\
    import traceback\n\
    traceback.print_exc()\n\
    sys.exit(1)\n\
' > /app/download_models.py

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
RUN chmod +x /app/download_models.py && python /app/download_models.py

COPY app/ /app/
RUN wget https://huggingface.co/qualcomm/Real-ESRGAN-General-x4v3/resolve/main/Real-ESRGAN-General-x4v3.onnx -O /app/utils/realesrgan-general-x4v3.onnx

# ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚­ì œ (ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”)
RUN rm /app/download_models.py

# ==========================================
# Stage 2: ëŸ°íƒ€ì„ ìŠ¤í…Œì´ì§€ (ìµœì¢… ì´ë¯¸ì§€)
# ==========================================
FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime AS runtime

#RUN apt-get update && apt-get install -y fonts-nanum && fc-cache -fv
RUN apt-get update && apt-get install -y fonts-nanum fontconfig && fc-cache -fv


# ëŸ°íƒ€ì„ì— í•„ìš”í•œ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ë°°ì§€ ì„œë¹„ìŠ¤ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤)
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libgl1 \
    libvulkan1 \
    libnss3 \
    libxss1 \
    libappindicator3-1 \
    libasound2 \
    fonts-liberation \
    xdg-utils \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm1 \
    wget \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ”‘ ë¹Œë“œ ì‹œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë“¤ì„ ARGë¡œ ë°›ì•„ì„œ ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
ARG HUGGINGFACE_HUB_TOKEN
ARG BE_SERVER_URL
ARG AI_SERVER_URL
ARG GCP_PROJECT_ID
ARG ARTIFACT_REGISTRY_LOCATION
ARG GCP_QUEUE_NAME
ARG GCP_SERVICE_EMAIL
ARG GOOGLE_APPLICATION_CREDENTIALS
ARG BUCKET_NAME
ENV HF_AUTH_TOKEN_VICKY=${HUGGINGFACE_HUB_TOKEN}
ENV HF_AUTH_TOKEN=${HUGGINGFACE_HUB_TOKEN}
ENV HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN}
ENV BE_SERVER_URL=${BE_SERVER_URL}
ENV AI_SERVER_URL=${AI_SERVER_URL}
ENV GCP_PROJECT_ID=${GCP_PROJECT_ID}
ENV ARTIFACT_REGISTRY_LOCATION=${ARTIFACT_REGISTRY_LOCATION}
ENV GCP_QUEUE_NAME=${GCP_QUEUE_NAME}
ENV GCP_SERVICE_EMAIL=${GCP_SERVICE_EMAIL}
ENV GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
ENV BUCKET_NAME=${BUCKET_NAME}

# ìºì‹œ ë””ë ‰í† ë¦¬ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV HUGGINGFACE_HUB_CACHE=/app/.cache/huggingface
ENV TRANSFORMERS_CACHE=/app/.cache/transformers
ENV HF_HOME=/app/.cache/huggingface

# Stage 1ì—ì„œ ë‹¤ìš´ë¡œë“œëœ ëª¨ë¸ ìºì‹œ ë³µì‚¬
COPY --from=model-downloader /app/.cache /app/.cache

# requirements.txt ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.badge.txt .
RUN pip install --upgrade pip && \
    pip install -r requirements.badge.txt

# Chrome ì„¤ì¹˜ (íŒ€ ë¡œê³  í¬ë¡¤ë§ìš©)
RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chrome-linux64.zip && \
    unzip chrome-linux64.zip && \
    mv chrome-linux64 /opt/chrome && \
    ln -s /opt/chrome/chrome /usr/bin/google-chrome && \
    rm chrome-linux64.zip

RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chromedriver-linux64.zip && \
    unzip chromedriver-linux64.zip && \
    mv chromedriver-linux64/chromedriver /usr/bin/chromedriver && \
    chmod +x /usr/bin/chromedriver && \
    rm -rf chromedriver-linux64*

# ì•± ì½”ë“œ ë³µì‚¬
COPY . .

# Chrome í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì›¹ í¬ë¡¤ë§ìš©)
ENV CHROME_BIN=/usr/bin/google-chrome
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# ğŸ” ëŸ°íƒ€ì„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# í™˜ê²½ ë³€ìˆ˜ë¥¼ .env íŒŒì¼ì— ì“´ í›„ Python ì•± ì‹¤í–‰
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ğŸš€ ë°°ì§€ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."\n\
\n\
# ëŸ°íƒ€ì„ì— í™˜ê²½ ë³€ìˆ˜ë¥¼ .env íŒŒì¼ì— ì €ì¥\n\
echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ë¥¼ .env íŒŒì¼ì— ì„¤ì • ì¤‘..."\n\
\n\
if [ ! -z "$HF_AUTH_TOKEN_VICKY" ]; then\n\
    echo "HF_AUTH_TOKEN_VICKY=$HF_AUTH_TOKEN_VICKY" > .env\n\
    echo "HF_AUTH_TOKEN=$HF_AUTH_TOKEN_VICKY" >> .env\n\
    echo "HUGGINGFACE_HUB_TOKEN=$HF_AUTH_TOKEN_VICKY" >> .env\n\
    echo "âœ… HF í† í° ì„¤ì • ì™„ë£Œ (í† í°: ${HF_AUTH_TOKEN_VICKY:0:10}****)"\n\
else\n\
    echo "âŒ HF_AUTH_TOKEN_VICKY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"\n\
    echo "ğŸ’¡ ë‹¤ìŒê³¼ ê°™ì´ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì „ë‹¬í•´ì£¼ì„¸ìš”:"\n\
    echo "   docker run -e HF_AUTH_TOKEN_VICKY=your_token ..."\n\
    exit 1\n\
fi\n\
\n\
# ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë“¤ì„ .env íŒŒì¼ì— ì¶”ê°€\n\
[ ! -z "$BE_SERVER_URL" ] && echo "BE_SERVER_URL=$BE_SERVER_URL" >> .env && echo "âœ… BE_SERVER_URL ì„¤ì •: $BE_SERVER_URL"\n\
[ ! -z "$AI_SERVER_URL" ] && echo "AI_SERVER_URL=$AI_SERVER_URL" >> .env && echo "âœ… AI_SERVER_URL ì„¤ì •: $AI_SERVER_URL"\n\
[ ! -z "$GCP_PROJECT_ID" ] && echo "GCP_PROJECT_ID=$GCP_PROJECT_ID" >> .env && echo "âœ… GCP_PROJECT_ID ì„¤ì •: $GCP_PROJECT_ID"\n\
[ ! -z "$ARTIFACT_REGISTRY_LOCATION" ] && echo "ARTIFACT_REGISTRY_LOCATION=$ARTIFACT_REGISTRY_LOCATION" >> .env && echo "âœ… ARTIFACT_REGISTRY_LOCATION ì„¤ì •: $ARTIFACT_REGISTRY_LOCATION"\n\
[ ! -z "$GCP_QUEUE_NAME" ] && echo "GCP_QUEUE_NAME=$GCP_QUEUE_NAME" >> .env && echo "âœ… GCP_QUEUE_NAME ì„¤ì •: $GCP_QUEUE_NAME"\n\
[ ! -z "$GCP_SERVICE_EMAIL" ] && echo "GCP_SERVICE_EMAIL=$GCP_SERVICE_EMAIL" >> .env && echo "âœ… GCP_SERVICE_EMAIL ì„¤ì •: $GCP_SERVICE_EMAIL"\n\
[ ! -z "$GOOGLE_APPLICATION_CREDENTIALS" ] && echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> .env && echo "âœ… GOOGLE_APPLICATION_CREDENTIALS ì„¤ì •: $GOOGLE_APPLICATION_CREDENTIALS"\n\
[ ! -z "$BUCKET_NAME" ] && echo "BUCKET_NAME=$BUCKET_NAME" >> .env && echo "âœ… BUCKET_NAME ì„¤ì •: $BUCKET_NAME"\n\
\n\
echo "ğŸ¯ FastAPI ì•± ì‹¤í–‰ ì¤‘..."\n\
exec "$@"\n\
' > /app/start.sh && chmod +x /app/start.sh

# ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ì„¤ì •
ENTRYPOINT ["/app/start.sh"]

# ë°°ì§€ ì„œë¹„ìŠ¤ FastAPI ì•± ì‹¤í–‰
CMD ["uvicorn", "app.main_badge:app_badge", "--host", "0.0.0.0", "--port", "8080"]
