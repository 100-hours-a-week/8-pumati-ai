# PyTorch 2.7.0 with CUDA 12.1 (ê³µì‹ ì´ë¯¸ì§€)
FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime
# syntax=docker/dockerfile:1.4
#FROM --platform=linux/amd64 pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime

#FROM pytorch/pytorch:2.7.0-cuda11.8-cudnn8-devel
#FROM pytorch/pytorch:2.7.0-cuda11.8-cudnn8-runtime
#2.7.0-cuda11.8-cudnn8-runtime

# ê¸°ë³¸ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜: libglib2.0-0, libgl1ì€ cv2ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¤í–‰ì„ ìœ„í•œ í•„ìˆ˜ íŒ¨í‚¤ì§€. 
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libgl1 \
    git \
    curl \
    libvulkan1 \
    chromium-browser \
    chromium-chromedriver \
    wget \
    unzip \
    libnss3 \
    libxss1 \
    libappindicator3-1 \
    libasound2 \
    fonts-liberation \
    xdg-utils \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm1 \
    #libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ìºì‹œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV HUGGINGFACE_HUB_CACHE=/app/.cache/huggingface
ENV TRANSFORMERS_CACHE=/app/.cache/transformers
ENV HF_HOME=/app/.cache/huggingface
RUN mkdir -p /app/.cache/huggingface /app/.cache/transformers

# requirements.txt ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.badge.txt .
RUN pip install --upgrade pip
RUN pip install -r requirements.badge.txt

# RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
#     apt-get install -y ./google-chrome-stable_current_amd64.deb && \
#     rm google-chrome-stable_current_amd64.deb

RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chrome-linux64.zip && \
    unzip chrome-linux64.zip && \
    mv chrome-linux64 /opt/chrome && \
    ln -s /opt/chrome/chrome /usr/bin/google-chrome && \
    rm chrome-linux64.zip

RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chromedriver-linux64.zip && \
unzip chromedriver-linux64.zip && \
mv chromedriver-linux64/chromedriver /usr/bin/chromedriver && \
chmod +x /usr/bin/chromedriver && \
rm -rf chromedriver-linux64* 

# ğŸš€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
ARG HUGGINGFACE_HUB_TOKEN
ENV HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN}

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/usr/bin/env python3\n\
import os\n\
import sys\n\
import time\n\
from huggingface_hub import login, snapshot_download\n\
import torch\n\
\n\
print("ğŸš€ Docker ë¹Œë“œ ì¤‘ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘ (ë©”ëª¨ë¦¬ ìµœì í™”)")\n\
\n\
# HF í† í° í™•ì¸\n\
token = os.getenv("HUGGINGFACE_HUB_TOKEN")\n\
if not token:\n\
    print("âŒ HUGGINGFACE_HUB_TOKENê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")\n\
    sys.exit(1)\n\
\n\
print(f"ğŸ”‘ í† í° í™•ì¸: {token[:10]}****")\n\
\n\
# Hugging Face ë¡œê·¸ì¸\n\
try:\n\
    login(token=token)\n\
    print("âœ… Hugging Face ë¡œê·¸ì¸ ì„±ê³µ!")\n\
except Exception as e:\n\
    print(f"âŒ Hugging Face ë¡œê·¸ì¸ ì‹¤íŒ¨: {e}")\n\
    sys.exit(1)\n\
\n\
# ìºì‹œ ë””ë ‰í† ë¦¬ í™•ì¸\n\
cache_dir = "/app/.cache/huggingface"\n\
print(f"ğŸ“ ìºì‹œ ë””ë ‰í† ë¦¬: {cache_dir}")\n\
\n\
def download_with_retry(repo_id, max_retries=3):\n\
    """ì¬ì‹œë„ ë¡œì§ì´ ìˆëŠ” ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜"""\n\
    for attempt in range(max_retries):\n\
        try:\n\
            print(f"ğŸ“¥ {repo_id} ë‹¤ìš´ë¡œë“œ ì‹œë„ {attempt + 1}/{max_retries}...")\n\
            snapshot_download(\n\
                repo_id,\n\
                cache_dir=cache_dir,\n\
                local_files_only=False,\n\
                resume_download=True,\n\
                max_workers=2\n\
            )\n\
            print(f"âœ… {repo_id} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")\n\
            return True\n\
        except Exception as e:\n\
            print(f"âŒ {repo_id} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}): {e}")\n\
            if attempt < max_retries - 1:\n\
                wait_time = (attempt + 1) * 10\n\
                print(f"â³ {wait_time}ì´ˆ í›„ ì¬ì‹œë„...")\n\
                time.sleep(wait_time)\n\
            else:\n\
                print(f"ğŸ’¥ {repo_id} ìµœì¢… ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!")\n\
                return False\n\
    return False\n\
\n\
try:\n\
    # ğŸš€ ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ë‹¤ìš´ë¡œë“œ ë°©ì‹ (ì¬ì‹œë„ í¬í•¨)\n\
    models = [\n\
        ("diffusers/controlnet-canny-sdxl-1.0-small", "ControlNet"),\n\
        ("stabilityai/stable-diffusion-xl-base-1.0", "SDXL Base"),\n\
        ("stabilityai/stable-diffusion-xl-refiner-1.0", "Refiner")\n\
    ]\n\
    \n\
    for i, (repo_id, name) in enumerate(models, 1):\n\
        print(f"ğŸ“¥ {i}/3 {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘... (ë‹¤ìš´ë¡œë“œë§Œ)")\n\
        if not download_with_retry(repo_id):\n\
            print(f"ğŸ’¥ {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ë¡œ ë¹Œë“œ ì¤‘ë‹¨!")\n\
            sys.exit(1)\n\
        print(f"ğŸ‰ {name} ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!")\n\
        print("ğŸ’¾ ë©”ëª¨ë¦¬ ì •ë¦¬ ì¤‘...")\n\
        time.sleep(2)  # ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œê°„\n\
    \n\
    print("ğŸ‰ ëª¨ë“  ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œí™”)")\n\
    print("ğŸ’¡ ëŸ°íƒ€ì„ì—ì„œ ìºì‹œëœ ëª¨ë¸ì„ ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.")\n\
    \n\
except Exception as e:\n\
    print(f"âŒ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")\n\
    import traceback\n\
    traceback.print_exc()\n\
    sys.exit(1)\n\
' > /app/download_models.py

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
RUN chmod +x /app/download_models.py && python /app/download_models.py

# ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚­ì œ (ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”)
RUN rm /app/download_models.py

# ì•± ì½”ë“œ ë³µì‚¬
COPY . .

# Chrome í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# FastAPI ì•± ì‹¤í–‰ (í¬íŠ¸ëŠ” í•„ìš”ì— ë”°ë¼ ì¡°ì •)
CMD ["uvicorn", "app.main_badge:app_badge", "--host", "0.0.0.0", "--port", "8080"]