# PyTorch 2.7.0 with CUDA 12.1 (ê³µì‹ ì´ë¯¸ì§€)
FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime
# syntax=docker/dockerfile:1.4
#FROM --platform=linux/amd64 pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime

#FROM pytorch/pytorch:2.7.0-cuda11.8-cudnn8-devel
#FROM pytorch/pytorch:2.7.0-cuda11.8-cudnn8-runtime
#2.7.0-cuda11.8-cudnn8-runtime

# ê¸°ë³¸ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜: libglib2.0-0, libgl1ì€ cv2ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¤í–‰ì„ ìœ„í•œ í•„ìˆ˜ íŒ¨í‚¤ì§€. 
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libgl1 \
    git \
    curl \
    libvulkan1 \
    chromium-browser \
    chromium-chromedriver \
    wget \
    unzip \
    libnss3 \
    libxss1 \
    libappindicator3-1 \
    libasound2 \
    fonts-liberation \
    xdg-utils \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm1 \
    #libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ìºì‹œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV HUGGINGFACE_HUB_CACHE=/app/.cache/huggingface
ENV TRANSFORMERS_CACHE=/app/.cache/transformers
ENV HF_HOME=/app/.cache/huggingface
RUN mkdir -p /app/.cache/huggingface /app/.cache/transformers

# requirements.txt ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.badge.txt .
RUN pip install --upgrade pip
RUN pip install -r requirements.badge.txt

# RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
#     apt-get install -y ./google-chrome-stable_current_amd64.deb && \
#     rm google-chrome-stable_current_amd64.deb

RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chrome-linux64.zip && \
    unzip chrome-linux64.zip && \
    mv chrome-linux64 /opt/chrome && \
    ln -s /opt/chrome/chrome /usr/bin/google-chrome && \
    rm chrome-linux64.zip

RUN wget https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/137.0.7151.70/linux64/chromedriver-linux64.zip && \
unzip chromedriver-linux64.zip && \
mv chromedriver-linux64/chromedriver /usr/bin/chromedriver && \
chmod +x /usr/bin/chromedriver && \
rm -rf chromedriver-linux64* 

# ğŸš€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
ARG HUGGINGFACE_HUB_TOKEN
ENV HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN}

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/usr/bin/env python3\n\
import os\n\
import sys\n\
from huggingface_hub import login, snapshot_download\n\
import torch\n\
\n\
print("ğŸš€ Docker ë¹Œë“œ ì¤‘ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘ (ë©”ëª¨ë¦¬ ìµœì í™”)")\n\
\n\
# HF í† í° í™•ì¸\n\
token = os.getenv("HUGGINGFACE_HUB_TOKEN")\n\
if not token:\n\
    print("âŒ HUGGINGFACE_HUB_TOKENê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")\n\
    sys.exit(1)\n\
\n\
print(f"ğŸ”‘ í† í° í™•ì¸: {token[:10]}****")\n\
\n\
# Hugging Face ë¡œê·¸ì¸\n\
try:\n\
    login(token=token)\n\
    print("âœ… Hugging Face ë¡œê·¸ì¸ ì„±ê³µ!")\n\
except Exception as e:\n\
    print(f"âŒ Hugging Face ë¡œê·¸ì¸ ì‹¤íŒ¨: {e}")\n\
    sys.exit(1)\n\
\n\
# ìºì‹œ ë””ë ‰í† ë¦¬ í™•ì¸\n\
cache_dir = "/app/.cache/huggingface"\n\
print(f"ğŸ“ ìºì‹œ ë””ë ‰í† ë¦¬: {cache_dir}")\n\
\n\
try:\n\
    # ğŸš€ ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ë‹¤ìš´ë¡œë“œ ë°©ì‹ (ë¡œë”©í•˜ì§€ ì•ŠìŒ)\n\
    print("ğŸ“¥ 1/3 ControlNet ë‹¤ìš´ë¡œë“œ ì¤‘... (ë‹¤ìš´ë¡œë“œë§Œ)")\n\
    snapshot_download(\n\
        "diffusers/controlnet-canny-sdxl-1.0-small",\n\
        cache_dir=cache_dir,\n\
        local_files_only=False\n\
    )\n\
    print("âœ… ControlNet ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")\n\
    \n\
    print("ğŸ“¥ 2/3 SDXL Base ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘... (ë‹¤ìš´ë¡œë“œë§Œ)")\n\
    snapshot_download(\n\
        "stabilityai/stable-diffusion-xl-base-1.0",\n\
        cache_dir=cache_dir,\n\
        local_files_only=False\n\
    )\n\
    print("âœ… SDXL Base ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")\n\
    \n\
    print("ğŸ“¥ 3/3 Refiner ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘... (ë‹¤ìš´ë¡œë“œë§Œ)")\n\
    snapshot_download(\n\
        "stabilityai/stable-diffusion-xl-refiner-1.0",\n\
        cache_dir=cache_dir,\n\
        local_files_only=False\n\
    )\n\
    print("âœ… Refiner ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")\n\
    \n\
    print("ğŸ‰ ëª¨ë“  ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œí™”)")\n\
    print("ğŸ’¡ ëŸ°íƒ€ì„ì—ì„œ ìºì‹œëœ ëª¨ë¸ì„ ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.")\n\
    \n\
except Exception as e:\n\
    print(f"âŒ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")\n\
    import traceback\n\
    traceback.print_exc()\n\
    sys.exit(1)\n\
' > /app/download_models.py

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
RUN chmod +x /app/download_models.py && python /app/download_models.py

# ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚­ì œ (ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”)
RUN rm /app/download_models.py

# ì•± ì½”ë“œ ë³µì‚¬
COPY . .

# Chrome í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# FastAPI ì•± ì‹¤í–‰ (í¬íŠ¸ëŠ” í•„ìš”ì— ë”°ë¼ ì¡°ì •)
CMD ["uvicorn", "app.main_badge:app_badge", "--host", "0.0.0.0", "--port", "8080"]